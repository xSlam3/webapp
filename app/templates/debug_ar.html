{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ AR –æ–±—ä–µ–∫—Ç–æ–≤</h1>
            <p class="text-gray-600">–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è AR –æ–±—ä–µ–∫—Ç–æ–≤ —Å ORB –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <button id="checkButton" onclick="checkARObjects()"
                    class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-medium mb-4">
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å AR –æ–±—ä–µ–∫—Ç—ã
            </button>

            <div id="results" class="hidden">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h2>
                <div id="resultContent" class="space-y-4"></div>
            </div>

            <div id="loading" class="hidden text-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </div>

    </div>
</div>

<script>
async function checkARObjects() {
    const loadingDiv = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');
    const resultContent = document.getElementById('resultContent');

    loadingDiv.classList.remove('hidden');
    resultsDiv.classList.add('hidden');

    try {
        const response = await fetch('/objects/api/debug/ar-objects');
        const data = await response.json();

        resultContent.innerHTML = '';

        // –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4';
        summaryDiv.innerHTML = `
            <p class="text-lg font-semibold">–í—Å–µ–≥–æ AR –æ–±—ä–µ–∫—Ç–æ–≤: ${data.total_ar_objects}</p>
            <p class="text-sm text-gray-600 mt-1">
                –° ORB –ø—Ä–∏–∑–Ω–∞–∫–∞–º–∏: ${data.objects.filter(obj => obj.has_orb_features).length}
            </p>
        `;
        resultContent.appendChild(summaryDiv);

        // –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤
        if (data.objects.length === 0) {
            const noObjectsDiv = document.createElement('div');
            noObjectsDiv.className = 'bg-yellow-50 border border-yellow-200 rounded-lg p-4';
            noObjectsDiv.innerHTML = `
                <p class="text-yellow-800 font-medium">‚ö†Ô∏è –í –±–∞–∑–µ –Ω–µ—Ç AR –æ–±—ä–µ–∫—Ç–æ–≤</p>
                <p class="text-sm text-yellow-700 mt-1">–°–æ–∑–¥–∞–π—Ç–µ AR –æ–±—ä–µ–∫—Ç —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</p>
            `;
            resultContent.appendChild(noObjectsDiv);
        } else {
            data.objects.forEach(obj => {
                const objDiv = document.createElement('div');
                const statusClass = obj.has_orb_features ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                const statusIcon = obj.has_orb_features ? '‚úÖ' : '‚ùå';
                const statusText = obj.has_orb_features ? '–ì–æ—Ç–æ–≤ –∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é' : '–ù–ï–¢ ORB –ø—Ä–∏–∑–Ω–∞–∫–æ–≤';

                objDiv.className = `${statusClass} border rounded-lg p-4`;
                objDiv.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-semibold text-gray-800">${statusIcon} ${obj.name}</h3>
                            <p class="text-sm text-gray-600 mt-1">ID: ${obj.id}</p>
                            <p class="text-sm text-gray-600">–°—Ç–∞—Ç—É—Å: ${statusText}</p>
                            ${obj.recognition_image ? `<p class="text-sm text-gray-600">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ${obj.recognition_image}</p>` : '<p class="text-sm text-red-600">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</p>'}
                            ${obj.has_orb_features ? `
                                <p class="text-xs text-gray-500 mt-2">
                                    –ö–ª—é—á–µ–≤—ã—Ö —Ç–æ—á–µ–∫: ${obj.orb_keypoints_length} —Å–∏–º–≤–æ–ª–æ–≤<br>
                                    –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–æ–≤: ${obj.orb_descriptors_length} –±–∞–π—Ç
                                </p>
                            ` : ''}
                        </div>
                    </div>
                `;
                resultContent.appendChild(objDiv);
            });
        }

        // –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        const hasObjectsWithoutOrb = data.objects.some(obj => !obj.has_orb_features);
        if (hasObjectsWithoutOrb) {
            const recommendationDiv = document.createElement('div');
            recommendationDiv.className = 'bg-orange-50 border border-orange-200 rounded-lg p-4 mt-4';
            recommendationDiv.innerHTML = `
                <h3 class="font-semibold text-orange-800 mb-2">üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3>
                <ul class="list-disc list-inside text-sm text-orange-700 space-y-1">
                    <li>–ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ AR –æ–±—ä–µ–∫—Ç—ã –±–µ–∑ ORB –ø—Ä–∏–∑–Ω–∞–∫–æ–≤</li>
                    <li>–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ç–∫–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</li>
                    <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ venv (—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º OpenCV)</li>
                </ul>
            `;
            resultContent.appendChild(recommendationDiv);
        }

        resultsDiv.classList.remove('hidden');
    } catch (error) {
        resultContent.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800 font-medium">‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö</p>
                <p class="text-sm text-red-700 mt-1">${error.message}</p>
            </div>
        `;
        resultsDiv.classList.remove('hidden');
    } finally {
        loadingDiv.classList.add('hidden');
    }
}
</script>
{% endblock %}
