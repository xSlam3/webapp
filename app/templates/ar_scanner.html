{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- –•–µ–¥–µ—Ä -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">üì± AR –°–∫–∞–Ω–µ—Ä</h1>
            <p class="text-gray-600 mt-1">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–≥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É—á–µ–±–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞</p>
            <p class="text-xs text-gray-500 mt-2">üí° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ QR –∫–æ–¥–æ–≤ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ –∞–ª–≥–æ—Ä–∏—Ç–º ORB (—É–ø–∞–∫–æ–≤–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤, –º–∞—Ä–∫–µ—Ä—ã –∏ —Ç.–¥.)</p>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è AR -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div id="arContainer" style="position: relative; width: 100%; height: 70vh; background: #000; overflow: hidden;">
                <!-- –í–∏–¥–µ–æ –ø–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã (–¥–ª—è QR –∏ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è) -->
                <video id="video" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                
                <!-- Canvas –¥–ª—è QR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è -->
                <canvas id="canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>
                
                <!-- MindAR –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤–æ–π canvas –∑–¥–µ—Å—å (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è) -->
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–∞ -->
                <div id="materialOverlay" class="hidden absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-10">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="p-6">
                            <button onclick="closeMaterialOverlay()" class="float-right text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
                            <div id="materialContent" class="mt-4">
                                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="loadingIndicator" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
                    <div class="text-white text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                        <p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...</p>
                    </div>
                </div>
            </div>
            
            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
            <div class="p-6 bg-gray-50 border-t border-gray-200">
                <h3 class="font-semibold text-gray-800 mb-2">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:</h3>
                <ul class="text-sm text-gray-600 space-y-1">
                    <li>‚Ä¢ –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ</li>
                    <li>‚Ä¢ –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –∏–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–≥–∞ (—É–ø–∞–∫–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–∞, –º–∞—Ä–∫–µ—Ä)</li>
                    <li>‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ç–∫–æ–µ, —Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω–æ –∏ –≤–∏–¥–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é</li>
                    <li>‚Ä¢ <strong>–î–µ—Ä–∂–∏—Ç–µ –∫–∞–º–µ—Ä—É —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Å–µ–∫—É–Ω–¥</strong> - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞–¥—Ä–∞ –ø–µ—Ä–µ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º</li>
                    <li>‚Ä¢ –£—á–µ–±–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ –∞–ª–≥–æ—Ä–∏—Ç–º ORB</li>
                    <li>‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</li>
                </ul>
                <div id="recognitionStatus" class="mt-3 text-xs text-gray-500 hidden">
                    <span id="statusText">–û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è...</span>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- AR.js –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ -->
<script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@ar-js-org/ar.js@3.4.2/build/ar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<!-- MindAR –æ—Ç–∫–ª—é—á–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<!-- MindAR —Ç—Ä–µ–±—É–µ—Ç ES6 –º–æ–¥—É–ª–∏, —á—Ç–æ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π -->
<!-- –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∏–∫—Å–µ–ª–µ–π –Ω–∞ canvas -->
<script>
console.log('‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–±–µ–∑ MindAR)');
</script>

<script>
let video, canvas, ctx;
let detectedTagId = null;
let detectedQRString = null; // –•—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ QR –∫–æ–¥–∞
let materialData = null;
let currentStream = null; // –•—Ä–∞–Ω–∏–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ—Ç–æ–∫ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
let mindARController = null; // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä MindAR
let arReady = false; // –§–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ AR
let tagImages = new Map(); // –ö–µ—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–µ–≥–æ–≤
let tagTargets = new Map(); // –ö–µ—à —Ü–µ–ª–µ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è MindAR
let simpleImageDetectionActive = false; // –§–ª–∞–≥ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
let allTags = []; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–≥–∏ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (ORB)
let stableFrameCount = 0;
let stableFrameThreshold = 3; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤ (–ø—Ä–∏–º–µ—Ä–Ω–æ 3 —Å–µ–∫—É–Ω–¥—ã)
let lastFrameData = null;
let frameStabilityThreshold = 0.95; // –ü–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ –∫–∞–¥—Ä–æ–≤ (95%)

// –ü–æ–ª—É—á–∏—Ç—å getUserMedia —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
function getUserMedia(constraints) {
    // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π API (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ)
    if (typeof navigator !== 'undefined' && 
        navigator.mediaDevices && 
        typeof navigator.mediaDevices.getUserMedia === 'function') {
        return navigator.mediaDevices.getUserMedia(constraints);
    }
    
    // –°—Ç–∞—Ä—ã–π API (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    const getUserMediaLegacy = (typeof navigator !== 'undefined' && 
                                (navigator.getUserMedia || 
                                 navigator.webkitGetUserMedia || 
                                 navigator.mozGetUserMedia || 
                                 navigator.msGetUserMedia));
    
    if (getUserMediaLegacy) {
        return new Promise((resolve, reject) => {
            const legacyFunc = navigator.getUserMedia || 
                              navigator.webkitGetUserMedia || 
                              navigator.mozGetUserMedia || 
                              navigator.msGetUserMedia;
            legacyFunc.call(navigator, constraints, resolve, reject);
        });
    }
    
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
    // (–Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö API –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(resolve)
                    .catch(reject);
            } else {
                reject(new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'));
            }
        }, 100);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞ –∫–∞–º–µ—Ä—ã
function stopCameraStream() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => {
            track.stop();
            console.log('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç—Ä–µ–∫ –∫–∞–º–µ—Ä—ã:', track.kind);
        });
        currentStream = null;
    }
    if (video && video.srcObject) {
        video.srcObject = null;
    }
}

// –§—É–Ω–∫—Ü–∏—è checkCameraSupport –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —Å—Ä–∞–∑—É –ø—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function init() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    stopCameraStream();
    
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤–∏–¥–µ–æ –∏ canvas
    video = document.getElementById('video');
    canvas = document.getElementById('canvas');
    
    if (!video) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç video –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    if (!canvas) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç canvas –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —á–∞—Å—Ç–æ–≥–æ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ canvas
    ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS (–∫—Ä–æ–º–µ localhost)
    const isLocalhost = location.hostname === 'localhost' || 
                        location.hostname === '127.0.0.1' || 
                        location.hostname === '[::1]';
    const isSecure = location.protocol === 'https:' || isLocalhost;
    
    if (!isSecure) {
        showError('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ localhost.');
        return;
    }
    
    // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR —Å–∫–∞–Ω–µ—Ä–∞:', {
        mediaDevices: !!navigator.mediaDevices,
        getUserMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
        legacyGetUserMedia: !!(navigator.getUserMedia || navigator.webkitGetUserMedia),
        protocol: location.protocol,
        hostname: location.hostname,
        isSecure: isSecure,
        userAgent: navigator.userAgent
    });
    
    // –ù–µ –¥–µ–ª–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É - —Å—Ä–∞–∑—É –ø—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ
    // –≠—Ç–æ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ, –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    try {
        // –ü—Ä–æ–±—É–µ–º –∑–∞–ø—Ä–æ—Å–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –ª—É—á—à–µ —Å–Ω–∞—á–∞–ª–∞ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å
        let stream = null;
        let lastError = null;
        
        // –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π)
        try {
            console.log('–ü—Ä–æ–±—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ –∫–∞–º–µ—Ä–µ...');
            stream = await getUserMedia({ video: true });
            console.log('–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ (–ø—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å)');
        } catch (simpleError) {
            console.log('–ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', simpleError);
            lastError = simpleError;
            
            // –í–∞—Ä–∏–∞–Ω—Ç 2: –° –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä–æ–π (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
            try {
                stream = await getUserMedia({ 
                    video: { 
                        facingMode: 'environment'
                    } 
                });
                console.log('–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ (–∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞)');
            } catch (envError) {
                console.log('–ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø—Ä–æ–±—É–µ–º –ª—é–±—É—é –∫–∞–º–µ—Ä—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', envError);
                lastError = envError;
                
                // –í–∞—Ä–∏–∞–Ω—Ç 3: –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–∞—á–µ—Å—Ç–≤–∞
                try {
                    stream = await getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    });
                    console.log('–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ (—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–∞—á–µ—Å—Ç–≤–∞)');
                } catch (qualityError) {
                    console.error('–í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏');
                    lastError = qualityError;
                    throw qualityError;
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ—Ç–æ–∫ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—á–∏—Å—Ç–∫–∏
        currentStream = stream;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–µ–∫–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä—ã–ª –∫–∞–º–µ—Ä—É –≤ –¥—Ä—É–≥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)
        stream.getTracks().forEach(track => {
            track.onended = () => {
                console.log('–¢—Ä–µ–∫ –∫–∞–º–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', track.kind);
                showError('–ö–∞–º–µ—Ä–∞ –±—ã–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø —Å–Ω–æ–≤–∞.');
            };
        });
        
        video.srcObject = stream;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
        video.addEventListener('loadedmetadata', () => {
            console.log(`üìπ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${video.videoWidth}x${video.videoHeight}`);
            // –î–ª—è QR –∫–æ–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º canvas
            if (canvas && ctx) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                console.log(`üé® Canvas —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${canvas.width}x${canvas.height}`);
            }
            hideLoading();
            startDetection();
        }, { once: true });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        video.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', e);
            stopCameraStream();
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
        });
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        try {
            await video.play();
        } catch (playError) {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', playError);
            stopCameraStream();
            showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.');
        }
        
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
        console.error('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
            name: err.name,
            message: err.message,
            stack: err.stack
        });
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        stopCameraStream();
        
        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. ';
        
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            errorMessage += '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –±—ã–ª–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
            errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–∞–º–µ—Ä–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
            errorMessage += '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.';
        } else if (err.name === 'OverconstrainedError' || err.name === 'ConstraintNotSatisfiedError') {
            errorMessage += '–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è.';
        } else if (err.message && err.message.includes('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è')) {
            errorMessage = '–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä (Chrome, Firefox, Safari, Edge).';
        } else {
            errorMessage += `–û—à–∏–±–∫–∞: ${err.message || err.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Ä–∞–∑—Ä–µ—à–∏–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.`;
        }
        
        showError(errorMessage);
    }
}

// –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
function hideLoading() {
    document.getElementById('loadingIndicator').classList.add('hidden');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
function showError(message) {
    const loadingDiv = document.getElementById('loadingIndicator');
    loadingDiv.classList.remove('hidden');
    loadingDiv.innerHTML = `
        <div class="text-white text-center max-w-md mx-auto p-6">
            <div class="mb-4">
                <svg class="mx-auto h-12 w-12 text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <p class="text-red-300 mb-4 text-sm leading-relaxed">‚ö†Ô∏è ${message}</p>
            <div class="space-y-2">
                <button onclick="requestCameraAgain()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium shadow-md w-full">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
                <button onclick="location.reload()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium w-full">
                    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
            </div>
        </div>
    `;
}

// –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
async function requestCameraAgain() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
    stopCameraStream();
    
    const loadingDiv = document.getElementById('loadingIndicator');
    loadingDiv.innerHTML = `
        <div class="text-white text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p>–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...</p>
        </div>
    `;
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
    setTimeout(() => {
        init();
    }, 500);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç–µ–≥–æ–≤
async function loadTags() {
    try {
        const resp = await fetch('/ar/api/tags');
        const data = await resp.json();
        return data.tags || [];
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤:', err);
        return [];
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–≥–∞
async function loadTagImage(url) {
    if (tagImages.has(url)) {
        return tagImages.get(url);
    }
    
    return new Promise((resolve, reject) => {
        const img = new Image();
        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã CORS
        img.crossOrigin = 'anonymous';
        img.onload = () => {
            tagImages.set(url, img);
            console.log(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${url} (${img.width}x${img.height})`);
            resolve(img);
        };
        img.onerror = (e) => {
            console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ${url}:`, e);
            // –ü—Ä–æ–±—É–µ–º –±–µ–∑ CORS
            const img2 = new Image();
            img2.onload = () => {
                tagImages.set(url, img2);
                console.log(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –±–µ–∑ CORS: ${url}`);
                resolve(img2);
            };
            img2.onerror = reject;
            img2.src = url;
        };
        img.src = url;
    });
}

// MindAR –æ—Ç–∫–ª—é—á–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥
function initMindAR() {
    // MindAR –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Å—Ä–∞–∑—É –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–µ –≥–æ—Ç–æ–≤
    // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    console.log('‚ÑπÔ∏è MindAR –æ—Ç–∫–ª—é—á–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
    arReady = false;
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–≥–∞ –¥–ª—è MindAR
async function prepareTagForMindAR(tagId, tagImageUrl) {
    if (tagTargets.has(tagId)) {
        return tagTargets.get(tagId);
    }
    
    if (!arReady || typeof MINDAR === 'undefined') {
        console.warn(`‚ö†Ô∏è MindAR –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–µ–≥–∞ ${tagId}`);
        return null;
    }
    
    try {
        const img = await loadTagImage(tagImageUrl);
        
        // MindAR –∏—Å–ø–æ–ª—å–∑—É–µ—Ç URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
        tagTargets.set(tagId, {
            imageUrl: tagImageUrl,
            image: img,
            imageSize: { width: img.width, height: img.height }
        });
        
        console.log(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –¥–ª—è —Ç–µ–≥–∞ ${tagId} (MindAR)`);
        return tagTargets.get(tagId);
    } catch (e) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ–≥–∞ ${tagId}:`, e);
        return null;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MindAR –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
async function initMindARController(tags) {
    if (!arReady || typeof MINDAR === 'undefined' || typeof MINDAR.IMAGE === 'undefined') {
        console.warn('‚ö†Ô∏è MindAR –Ω–µ –≥–æ—Ç–æ–≤ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞');
        return null;
    }
    
    if (tags.length === 0) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç —Ç–µ–≥–æ–≤ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ MindAR');
        return null;
    }
    
    try {
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è MindAR
        const imageTargets = [];
        const tagIdMap = new Map(); // –ú–∞–ø–ø–∏–Ω–≥ –∏–Ω–¥–µ–∫—Å–∞ –≤ MindAR –∫ tagId
        
        for (let i = 0; i < tags.length; i++) {
            const tag = tags[i];
            const prepared = await prepareTagForMindAR(tag.id, tag.tag_image_url);
            if (prepared) {
                imageTargets.push({
                    file: tag.tag_image_url,
                    type: 'image'
                });
                tagIdMap.set(i, tag.id);
                console.log(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${i} –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ MindAR: —Ç–µ–≥ ${tag.id} (${tag.name})`);
            }
        }
        
        if (imageTargets.length === 0) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è MindAR');
            return null;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä MindAR
        // MindAR.IMAGE.MindARThree —Ç—Ä–µ–±—É–µ—Ç –º–∞—Å—Å–∏–≤ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        const imageUrls = imageTargets.map(t => t.file);
        
        const mindarImage = new MINDAR.IMAGE.MindARThree({
            container: document.getElementById('arContainer'),
            imageTargetSrc: imageUrls,
            maxTrack: imageTargets.length
        });
        
        const { renderer, scene, camera } = mindarImage;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞–ø–ø–∏–Ω–≥ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–æ–±—ã—Ç–∏—è—Ö
        mindarImage._tagIdMap = tagIdMap;
        mindarImage._tags = tags;
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        mindarImage.onTargetFound = (targetIndex) => {
            const tagId = mindarImage._tagIdMap.get(targetIndex);
            if (tagId && tagId !== detectedTagId) {
                console.log(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —á–µ—Ä–µ–∑ MindAR! –¢–µ–≥ ID: ${tagId}, –∏–Ω–¥–µ–∫—Å: ${targetIndex}`);
                const tag = mindarImage._tags.find(t => t.id === tagId);
                updateRecognitionStatus(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${tag ? tag.name : '–¢–µ–≥ ' + tagId}`, 'success');
                detectedTagId = tagId;
                handleTagDetected(tagId);
            }
        };
        
        mindarImage.onTargetLost = (targetIndex) => {
            console.log(`üîÑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ: –∏–Ω–¥–µ–∫—Å ${targetIndex}`);
            // –ú–æ–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å detectedTagId –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ü–µ–ª–∏
            // –ù–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å, —á—Ç–æ–±—ã –º–∞—Ç–µ—Ä–∏–∞–ª –æ—Å—Ç–∞–≤–∞–ª—Å—è –æ—Ç–∫—Ä—ã—Ç—ã–º
        };
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º MindAR
        await mindarImage.start();
        console.log('‚úÖ MindAR –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç');
        
        return mindarImage;
    } catch (e) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ MindAR –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞:', e);
        console.error('–î–µ—Ç–∞–ª–∏:', e.stack);
        return null;
    }
}

// –ù–∞—á–∞–ª–æ –¥–µ—Ç–µ–∫—Ü–∏–∏ QR –∫–æ–¥–æ–≤ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
async function startDetection() {
    const tags = await loadTags();
    
    console.log('üìã –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–µ–≥–æ–≤ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', tags.length);
    if (tags.length === 0) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç —Ç–µ–≥–æ–≤ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–æ–∑–¥–∞–ª–∏ AR —Ç–µ–≥–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.');
        updateRecognitionStatus('–ù–µ—Ç —Ç–µ–≥–æ–≤ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–≥–∏ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.', 'info');
    } else {
        tags.forEach(tag => {
            console.log(`  - –¢–µ–≥ ID ${tag.id}: ${tag.name} (${tag.tag_image_url})`);
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥)
    if (tags.length > 0) {
        console.log(`–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–ª—è ${tags.length} —Ç–µ–≥–æ–≤...`);
        // –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ (MindAR –æ—Ç–∫–ª—é—á–µ–Ω)
        initSimpleImageRecognition(tags);
    } else {
        console.warn('‚ö†Ô∏è –ù–µ—Ç —Ç–µ–≥–æ–≤ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è');
    }
    
    let lastDetectionTime = 0;
    const detectionInterval = 300; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 300–º—Å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const qrDetectionInterval = 500; // QR –∫–æ–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∂–µ
    let lastQRDetectionTime = 0;
    let lastImageDetectionTime = 0;
    
    let detectionMode = 'both'; // 'qr', 'image', 'both'
    let currentFrameMat = null;
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ canvas —Å —Ç–µ–∫—É—â–∏–º –∫–∞–¥—Ä–æ–º –≤–∏–¥–µ–æ
    function updateCanvas() {
        if (video && video.readyState === video.HAVE_ENOUGH_DATA && canvas && ctx) {
            try {
                // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–∞–∑–º–µ—Ä—ã canvas —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –≤–∏–¥–µ–æ
                if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                return true;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è canvas:', e);
                return false;
            }
        }
        return false;
    }
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º jsQR –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ QR –∫–æ–¥–æ–≤
    function detectQR() {
        const now = Date.now();
        if (now - lastQRDetectionTime < qrDetectionInterval) {
            requestAnimationFrame(detectQR);
            return;
        }
        lastQRDetectionTime = now;
        
        if (video.readyState === video.HAVE_ENOUGH_DATA && (detectionMode === 'qr' || detectionMode === 'both')) {
            // –û–±–Ω–æ–≤–ª—è–µ–º canvas –ø–µ—Ä–µ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ–º
            if (!updateCanvas()) {
                requestAnimationFrame(detectQR);
                return;
            }
            
            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR –∫–æ–¥
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    console.log('üîç QR –∫–æ–¥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω:', code.data);

                    const qrString = code.data.trim();

                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É QR –∫–æ–¥–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞
                    if (qrString && qrString !== detectedQRString) {
                        detectedQRString = qrString;
                        handleQRCodeDetected(qrString);
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ QR –∫–æ–¥–∞:', e);
            }
        }
        requestAnimationFrame(detectQR);
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–¥—Ä–∞
    function isFrameStable(currentFrameData) {
        if (!lastFrameData) {
            lastFrameData = currentFrameData;
            return false;
        }

        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
        let matchingPixels = 0;
        const totalPixels = currentFrameData.data.length / 4;
        const threshold = 30; // –ü–æ—Ä–æ–≥ —Ä–∞–∑–ª–∏—á–∏—è –ø–∏–∫—Å–µ–ª–µ–π

        for (let i = 0; i < currentFrameData.data.length; i += 4) {
            const rDiff = Math.abs(currentFrameData.data[i] - lastFrameData.data[i]);
            const gDiff = Math.abs(currentFrameData.data[i + 1] - lastFrameData.data[i + 1]);
            const bDiff = Math.abs(currentFrameData.data[i + 2] - lastFrameData.data[i + 2]);

            if (rDiff < threshold && gDiff < threshold && bDiff < threshold) {
                matchingPixels++;
            }
        }

        const similarity = matchingPixels / totalPixels;
        lastFrameData = currentFrameData;

        return similarity >= frameStabilityThreshold;
    }

    // ORB —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ backend
    async function recognizeImageWithORB() {
        try {
            // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –∫–∞–∫ blob
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å blob –∏–∑ canvas');
                    return;
                }

                // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const formData = new FormData();
                formData.append('image', blob, 'frame.jpg');

                updateRecognitionStatus('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ ORB...', 'scanning');

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ backend
                const response = await fetch('/ar/api/match-image', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
                    updateRecognitionStatus('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è', 'error');
                    return;
                }

                const result = await response.json();

                if (result.matched) {
                    console.log(`‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —á–µ—Ä–µ–∑ ORB! –¢–µ–≥: ${result.tag_name}, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${result.confidence}%`);
                    updateRecognitionStatus(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${result.tag_name} (${result.confidence}%)`, 'success');

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞—Ç–µ—Ä–∏–∞–ª
                    if (result.material) {
                        materialData = result.material;
                        detectedTagId = result.tag_id;
                        showMaterialOverlay(result.material);
                    }
                } else {
                    console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —á–µ—Ä–µ–∑ ORB');
                    updateRecognitionStatus('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ', 'info');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –∫–∞–¥—Ä–æ–≤
                    stableFrameCount = 0;
                }
            }, 'image/jpeg', 0.8);

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ ORB —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
            updateRecognitionStatus('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è', 'error');
        }
    }

    // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (fallback –µ—Å–ª–∏ MindAR –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    function initSimpleImageRecognition(tagsList) {
        if (simpleImageDetectionActive) return;
        simpleImageDetectionActive = true;
        allTags = tagsList; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–≥–∏
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ORB –º–µ—Ç–æ–¥–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...');
        console.log('‚úÖ ORB –º–µ—Ç–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤');
    }
    
    // –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ ORB –º–µ—Ç–æ–¥
    async function detectImageORB() {
        if (!simpleImageDetectionActive || detectedTagId !== null) {
            return;
        }

        if (video.readyState !== video.HAVE_ENOUGH_DATA) {
            return;
        }

        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º canvas
            if (!updateCanvas()) {
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞
            const frameData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞–¥—Ä–∞
            if (isFrameStable(frameData)) {
                stableFrameCount++;
                updateRecognitionStatus(`–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∫–∞–¥—Ä–∞... (${stableFrameCount}/${stableFrameThreshold})`, 'scanning');
                console.log(`–°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–∞–¥—Ä ${stableFrameCount}/${stableFrameThreshold}`);

                // –ï—Å–ª–∏ –∫–∞–¥—Ä —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–æ–ª–≥–æ (–ø—Ä–∏–º–µ—Ä–Ω–æ 3 —Å–µ–∫—É–Ω–¥—ã)
                if (stableFrameCount >= stableFrameThreshold) {
                    console.log('–ö–∞–¥—Ä —Å—Ç–∞–±–∏–ª–µ–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ORB...');
                    stableFrameCount = 0;
                    await recognizeImageWithORB();
                }
            } else {
                // –ö–∞–¥—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                if (stableFrameCount > 0) {
                    console.log('–ö–∞–¥—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è, —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞');
                    stableFrameCount = 0;
                    updateRecognitionStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'scanning');
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ ORB —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', e);
        }
    }
    
    // –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ MindAR –∏–ª–∏ ORB
    function detectImage() {
        if (mindARController) {
            // MindAR –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ —Å–æ–±—ã—Ç–∏—è
            // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (detectedTagId === null) {
                updateRecognitionStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'scanning');
            }
        } else if (simpleImageDetectionActive) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º ORB –º–µ—Ç–æ–¥
            detectImageORB();
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä—ã
    console.log('üöÄ –ó–∞–ø—É—Å–∫ –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–≤...');
    console.log(`- QR –¥–µ—Ç–µ–∫—Ç–æ—Ä: –∞–∫—Ç–∏–≤–µ–Ω`);
    const imageDetectorStatus = mindARController ? '–∞–∫—Ç–∏–≤–µ–Ω (MindAR)' :
                                (simpleImageDetectionActive ? '–∞–∫—Ç–∏–≤–µ–Ω (ORB –º–µ—Ç–æ–¥)' :
                                (arReady ? '–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MindAR...' : '–æ–∂–∏–¥–∞–Ω–∏–µ MindAR'));
    console.log(`- Image –¥–µ—Ç–µ–∫—Ç–æ—Ä: ${imageDetectorStatus}`);

    detectQR();

    // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    if (mindARController || simpleImageDetectionActive) {
        // –î–ª—è ORB –º–µ—Ç–æ–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        const interval = simpleImageDetectionActive ? 1000 : 1000;
        setInterval(() => {
            if (detectedTagId === null) {
                detectImage();
            }
        }, interval);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞
async function handleTagDetected(tagId) {
    console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞:', tagId);
    try {
        const resp = await fetch(`/ar/api/tag/${tagId}/material`);
        if (!resp.ok) {
            const errorText = await resp.text();
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', resp.status, errorText);
            throw new Error(`–ú–∞—Ç–µ—Ä–∏–∞–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (—Å—Ç–∞—Ç—É—Å: ${resp.status})`);
        }

        const data = await resp.json();
        console.log('–ú–∞—Ç–µ—Ä–∏–∞–ª –∑–∞–≥—Ä—É–∂–µ–Ω:', data.material);
        materialData = data.material;
        showMaterialOverlay(data.material);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞:', err);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∞: ' + err.message);
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ QR –∫–æ–¥–∞
async function handleQRCodeDetected(qrString) {
    console.log('üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ QR –∫–æ–¥–∞:', qrString);
    updateRecognitionStatus('QR –∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö...', 'success');

    try {
        const resp = await fetch(`/qr/api/search?qr_string=${encodeURIComponent(qrString)}`);
        if (!resp.ok) {
            const errorText = await resp.text();
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', resp.status, errorText);
            if (resp.status === 404) {
                updateRecognitionStatus('QR –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', 'info');
                // –°–±—Ä–æ—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π QR –∫–æ–¥
                setTimeout(() => {
                    detectedQRString = null;
                    updateRecognitionStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'scanning');
                }, 3000);
            } else {
                throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ (—Å—Ç–∞—Ç—É—Å: ${resp.status})`);
            }
            return;
        }

        const result = await resp.json();
        console.log('‚úÖ QR –æ–±—ä–µ–∫—Ç –Ω–∞–π–¥–µ–Ω:', result.data);
        showQRObjectOverlay(result.data);
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ QR –æ–±—ä–µ–∫—Ç–∞:', err);
        updateRecognitionStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: ' + err.message, 'error');
        // –°–±—Ä–æ—Å –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏
        setTimeout(() => {
            detectedQRString = null;
            updateRecognitionStatus('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', 'scanning');
        }, 3000);
    }
}

// –ü–æ–∫–∞–∑–∞—Ç—å QR –æ–±—ä–µ–∫—Ç –≤ overlay
function showQRObjectOverlay(qrObject) {
    const overlay = document.getElementById('materialOverlay');
    const content = document.getElementById('materialContent');

    let html = `
        <h2 class="text-2xl font-bold text-gray-800 mb-4">${qrObject.name}</h2>
    `;

    if (qrObject.photo) {
        html += `<img src="/static/${qrObject.photo}" alt="${qrObject.name}" class="w-full rounded-lg mb-4">`;
    }

    if (qrObject.description) {
        html += `<div class="prose max-w-none text-gray-700 mb-4 material-content">${qrObject.description}</div>`;
    }

    content.innerHTML = html;
    overlay.classList.remove('hidden');
    updateRecognitionStatus('QR –æ–±—ä–µ–∫—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è', 'success');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
function showMaterialOverlay(material) {
    const overlay = document.getElementById('materialOverlay');
    const content = document.getElementById('materialContent');
    
    let html = `
        <h2 class="text-2xl font-bold text-gray-800 mb-4">${material.title}</h2>
    `;
    
    if (material.photo) {
        html += `<img src="/static/${material.photo}" alt="${material.title}" class="w-full rounded-lg mb-4">`;
    }
    
    if (material.text) {
        html += `<div class="prose max-w-none text-gray-700 mb-4 material-content">${material.text}</div>`;
    }
    
    if (material.video) {
        html += `
            <video controls class="w-full rounded-lg mb-4">
                <source src="/static/${material.video}" type="video/mp4">
                –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
            </video>
        `;
    }
    
    html += `
        <div class="mt-4 pt-4 border-t border-gray-200">
            <a href="/knowledge_base/${material.id}" class="text-indigo-600 hover:text-indigo-800 font-medium">
                ‚Üí –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª
            </a>
        </div>
    `;
    
    content.innerHTML = html;
    overlay.classList.remove('hidden');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
function updateRecognitionStatus(text, type = 'scanning') {
    const statusDiv = document.getElementById('recognitionStatus');
    const statusText = document.getElementById('statusText');
    if (!statusDiv || !statusText) return;
    
    statusDiv.classList.remove('hidden');
    statusText.textContent = text;
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã
    statusText.classList.remove('text-gray-500', 'text-green-600', 'text-blue-600');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–ª–∞—Å—Å—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    if (type === 'success') {
        statusText.classList.add('text-green-600', 'font-semibold');
    } else if (type === 'info') {
        statusText.classList.add('text-blue-600');
    } else {
        statusText.classList.add('text-gray-500');
    }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª
function closeMaterialOverlay() {
    document.getElementById('materialOverlay').classList.add('hidden');
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    setTimeout(() => {
        detectedTagId = null;
        detectedQRString = null;
        updateRecognitionStatus('–ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é', 'scanning');
        console.log('–ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é');
    }, 1000);
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    initMindAR(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º MindAR
    init(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    stopCameraStream();
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º MindAR
    if (mindARController) {
        try {
            mindARController.stop();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ MindAR:', e);
        }
    }
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫ –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
        // –ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ, –ø–æ—ç—Ç–æ–º—É –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ
        // stopCameraStream();
    }
});
</script>

<style>
#arContainer {
    min-height: 500px;
}

#materialOverlay {
    backdrop-filter: blur(4px);
}

#materialContent {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}


