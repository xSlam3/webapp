{% extends "base.html" %}

{% block content %}
<div class="min-h-screen py-6 sm:py-8">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- –•–µ–¥–µ—Ä -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sm:p-8 mb-6">
            <div class="flex items-start space-x-3 mb-3">
                <div class="w-12 h-12 bg-gradient-to-br from-primary-500 to-primary-600 rounded-xl flex items-center justify-center shadow-md flex-shrink-0">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                    </svg>
                </div>
                <div class="flex-1">
                    <h1 class="text-2xl sm:text-3xl font-bold text-neutral-900">–°–∫–∞–Ω–µ—Ä AR/QR</h1>
                    <p class="text-neutral-600 text-sm mt-1">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –∏–ª–∏ AR –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ</p>
                    <p class="text-xs text-neutral-500 mt-2">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ ORB-–∞–ª–≥–æ—Ä–∏—Ç–º–∞ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</p>
                </div>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞ -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div id="scannerContainer" style="position: relative; width: 100%; height: 70vh; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); overflow: hidden;">
                <!-- –í–∏–¥–µ–æ –ø–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã -->
                <video id="video" autoplay playsinline muted style="width: 100%; height: 100%; object-fit: cover;"></video>

                <!-- Canvas –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è -->
                <canvas id="canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></canvas>

                <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–¥—Ä–∞ -->
                <div id="stabilityIndicator" class="hidden absolute top-4 left-4 right-4 bg-white bg-opacity-90 rounded-lg p-3 shadow-lg">
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-900">–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...</p>
                            <div class="mt-1 w-full bg-gray-200 rounded-full h-2">
                                <div id="stabilityProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                <div id="loadingIndicator" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
                    <div class="text-white text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
                        <p>–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...</p>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ —Å—Ç–∞—Ç—É—Å -->
            <div class="p-6 sm:p-8 bg-neutral-50 border-t border-gray-200">
                <div class="flex items-start space-x-3 mb-4">
                    <div class="flex-shrink-0">
                        <svg class="w-5 h-5 text-primary-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-semibold text-neutral-900 mb-3">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</h3>
                        <ul class="text-sm text-neutral-600 space-y-2">
                            <li class="flex items-start">
                                <span class="inline-block w-1.5 h-1.5 bg-primary-500 rounded-full mt-1.5 mr-2 flex-shrink-0"></span>
                                <span>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –±—Ä–∞—É–∑–µ—Ä–∞</span>
                            </li>
                            <li class="flex items-start">
                                <span class="inline-block w-1.5 h-1.5 bg-primary-500 rounded-full mt-1.5 mr-2 flex-shrink-0"></span>
                                <span>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –∏–ª–∏ AR –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (—É–ø–∞–∫–æ–≤–∫–∞, –º–∞—Ä–∫–µ—Ä)</span>
                            </li>
                            <li class="flex items-start">
                                <span class="inline-block w-1.5 h-1.5 bg-primary-500 rounded-full mt-1.5 mr-2 flex-shrink-0"></span>
                                <span>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ç–∫–æ–µ –∏ —Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω–æ</span>
                            </li>
                            <li class="flex items-start">
                                <span class="inline-block w-1.5 h-1.5 bg-primary-500 rounded-full mt-1.5 mr-2 flex-shrink-0"></span>
                                <span><strong class="font-semibold text-neutral-700">–î–µ—Ä–∂–∏—Ç–µ –∫–∞–º–µ—Ä—É —Å—Ç–∞–±–∏–ª—å–Ω–æ</strong> - —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –æ–±—ä–µ–∫—Ç</span>
                            </li>
                            <li class="flex items-start">
                                <span class="inline-block w-1.5 h-1.5 bg-primary-500 rounded-full mt-1.5 mr-2 flex-shrink-0"></span>
                                <span>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏</span>
                            </li>
                        </ul>
                    </div>
                </div>
                <div id="recognitionStatus" class="mt-4 px-4 py-2.5 bg-white rounded-lg border border-gray-200 hidden">
                    <span id="statusText" class="text-sm text-neutral-600">–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é...</span>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
let video, canvas, ctx;
let detectedObjectId = null;
let detectedQRString = null;
let currentStream = null;
let isScanning = true;

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è AR –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
let stableFrameCount = 0;
let stableFrameThreshold = 1; // 1 –ø—Ä–æ–≤–µ—Ä–∫–∞ = 1 —Å–µ–∫—É–Ω–¥–∞
let lastFrameData = null;
let frameStabilityThreshold = 0.95; // 95% —Å—Ö–æ–∂–µ—Å—Ç–∏ –∫–∞–¥—Ä–æ–≤
let lastARCheckTime = 0;
const arCheckInterval = 1000; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É

// –ü–æ–ª—É—á–∏—Ç—å getUserMedia —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
function getUserMedia(constraints) {
    if (typeof navigator !== 'undefined' &&
        navigator.mediaDevices &&
        typeof navigator.mediaDevices.getUserMedia === 'function') {
        return navigator.mediaDevices.getUserMedia(constraints);
    }

    const getUserMediaLegacy = (typeof navigator !== 'undefined' &&
                                (navigator.getUserMedia ||
                                 navigator.webkitGetUserMedia ||
                                 navigator.mozGetUserMedia ||
                                 navigator.msGetUserMedia));

    if (getUserMediaLegacy) {
        return new Promise((resolve, reject) => {
            const legacyFunc = navigator.getUserMedia ||
                              navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia ||
                              navigator.msGetUserMedia;
            legacyFunc.call(navigator, constraints, resolve, reject);
        });
    }

    return new Promise((resolve, reject) => {
        setTimeout(() => {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(resolve)
                    .catch(reject);
            } else {
                reject(new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'));
            }
        }, 100);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞ –∫–∞–º–µ—Ä—ã
function stopCameraStream() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => {
            track.stop();
            console.log('–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç—Ä–µ–∫ –∫–∞–º–µ—Ä—ã:', track.kind);
        });
        currentStream = null;
    }
    if (video && video.srcObject) {
        video.srcObject = null;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
async function init() {
    stopCameraStream();

    video = document.getElementById('video');
    canvas = document.getElementById('canvas');

    if (!video || !canvas) {
        console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        return;
    }

    ctx = canvas.getContext('2d', { willReadFrequently: true });

    const isLocalhost = location.hostname === 'localhost' ||
                        location.hostname === '127.0.0.1' ||
                        location.hostname === '[::1]';
    const isSecure = location.protocol === 'https:' || isLocalhost;

    if (!isSecure) {
        showError('–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
        return;
    }

    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞...');

    try {
        let stream = null;

        try {
            console.log('–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...');
            stream = await getUserMedia({
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            console.log('‚úÖ –î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –ø–æ–ª—É—á–µ–Ω');
        } catch (envError) {
            console.log('–ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª—é–±—É—é –∫–∞–º–µ—Ä—É');
            stream = await getUserMedia({ video: true });
        }

        currentStream = stream;

        stream.getTracks().forEach(track => {
            track.onended = () => {
                console.log('–¢—Ä–µ–∫ –∫–∞–º–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', track.kind);
                showError('–ö–∞–º–µ—Ä–∞ –±—ã–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            };
        });

        video.srcObject = stream;

        video.addEventListener('loadedmetadata', () => {
            console.log(`üìπ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${video.videoWidth}x${video.videoHeight}`);
            if (canvas && ctx) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                console.log(`üé® Canvas —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${canvas.width}x${canvas.height}`);
            }
            hideLoading();
            startDetection();
        }, { once: true });

        video.addEventListener('error', (e) => {
            console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', e);
            stopCameraStream();
            showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã');
        });

        await video.play();

    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
        stopCameraStream();

        let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. ';

        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            errorMessage += '–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞';
        } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
            errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
            errorMessage += '–ö–∞–º–µ—Ä–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º';
        } else {
            errorMessage += `–û—à–∏–±–∫–∞: ${err.message || err.name}`;
        }

        showError(errorMessage);
    }
}

// –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
function hideLoading() {
    document.getElementById('loadingIndicator').classList.add('hidden');
}

// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
function showError(message) {
    const loadingDiv = document.getElementById('loadingIndicator');
    loadingDiv.classList.remove('hidden');
    loadingDiv.innerHTML = `
        <div class="text-white text-center max-w-md mx-auto p-6">
            <div class="mb-4">
                <svg class="mx-auto h-12 w-12 text-red-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <p class="text-red-300 mb-4 text-sm leading-relaxed">‚ö†Ô∏è ${message}</p>
            <div class="space-y-2">
                <button onclick="requestCameraAgain()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition font-medium shadow-md w-full">
                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                </button>
                <button onclick="location.reload()" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition font-medium w-full">
                    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
            </div>
        </div>
    `;
}

// –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ
async function requestCameraAgain() {
    stopCameraStream();
    const loadingDiv = document.getElementById('loadingIndicator');
    loadingDiv.innerHTML = `
        <div class="text-white text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"></div>
            <p>–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ...</p>
        </div>
    `;
    setTimeout(() => init(), 500);
}

// –ù–∞—á–∞–ª–æ –¥–µ—Ç–µ–∫—Ü–∏–∏
function startDetection() {
    console.log('üöÄ –ó–∞–ø—É—Å–∫ –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–≤...');
    updateRecognitionStatus('–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é...', 'scanning');

    let lastQRDetectionTime = 0;
    const qrDetectionInterval = 500; // QR –∫–æ–¥—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 500–º—Å

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ canvas —Å —Ç–µ–∫—É—â–∏–º –∫–∞–¥—Ä–æ–º –≤–∏–¥–µ–æ
    function updateCanvas() {
        if (video && video.readyState === video.HAVE_ENOUGH_DATA && canvas && ctx) {
            try {
                if (canvas.width !== video.videoWidth || canvas.height !== video.videoHeight) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                }
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                return true;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è canvas:', e);
                return false;
            }
        }
        return false;
    }

    // –î–µ—Ç–µ–∫—Ü–∏—è QR –∫–æ–¥–æ–≤
    function detectQR() {
        if (!isScanning) {
            requestAnimationFrame(detectQR);
            return;
        }

        const now = Date.now();
        if (now - lastQRDetectionTime < qrDetectionInterval) {
            requestAnimationFrame(detectQR);
            return;
        }
        lastQRDetectionTime = now;

        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            if (!updateCanvas()) {
                requestAnimationFrame(detectQR);
                return;
            }

            try {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    console.log('üîç QR –∫–æ–¥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω:', code.data);
                    const qrString = code.data.trim();

                    if (qrString && qrString !== detectedQRString) {
                        detectedQRString = qrString;
                        handleQRCodeDetected(qrString);
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–∏ QR –∫–æ–¥–∞:', e);
            }
        }
        requestAnimationFrame(detectQR);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–¥—Ä–∞ (—É–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º)
    function isFrameStable(currentFrameData) {
        if (!lastFrameData) {
            lastFrameData = currentFrameData;
            return false;
        }

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
        let matchingPixels = 0;
        const totalPixels = currentFrameData.data.length / 4;
        const threshold = 35; // –£–≤–µ–ª–∏—á–µ–Ω –ø–æ—Ä–æ–≥ —Å 30 –¥–æ 35 –¥–ª—è –±–æ–ª—å—à–µ–π —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        const sampleRate = 4; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π 4-–π –ø–∏–∫—Å–µ–ª—å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è

        for (let i = 0; i < currentFrameData.data.length; i += 4 * sampleRate) {
            const rDiff = Math.abs(currentFrameData.data[i] - lastFrameData.data[i]);
            const gDiff = Math.abs(currentFrameData.data[i + 1] - lastFrameData.data[i + 1]);
            const bDiff = Math.abs(currentFrameData.data[i + 2] - lastFrameData.data[i + 2]);

            if (rDiff < threshold && gDiff < threshold && bDiff < threshold) {
                matchingPixels += sampleRate; // –ö–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ–º —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏–µ
            }
        }

        const similarity = matchingPixels / totalPixels;
        lastFrameData = currentFrameData;

        return similarity >= frameStabilityThreshold;
    }

    // AR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ORB
    async function recognizeImageWithORB() {
        try {
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å blob –∏–∑ canvas');
                    return;
                }

                const formData = new FormData();
                formData.append('image', blob, 'frame.jpg');

                updateRecognitionStatus('–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ AR –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...', 'scanning');

                const response = await fetch('/objects/api/match-image', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
                    updateRecognitionStatus('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è', 'error');
                    stableFrameCount = 0;
                    hideStabilityIndicator();
                    return;
                }

                const result = await response.json();

                if (result.matched) {
                    console.log(`‚úÖ AR –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω! ${result.object_name}, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${result.confidence}%`);
                    updateRecognitionStatus(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: ${result.object_name} (${result.confidence}%)`, 'success');
                    hideStabilityIndicator();

                    if (result.object_id) {
                        detectedObjectId = result.object_id;
                        isScanning = false;
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä–µ–∫—Ç–∞
                        updateRecognitionStatus('–ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–±—ä–µ–∫—Ç—É...', 'success');
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
                        stopCameraStream();
                        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                        window.location.href = `/objects/view/${result.object_id}`;
                    }
                } else {
                    console.log('AR –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ');
                    updateRecognitionStatus('–ü–æ–∏—Å–∫ AR –æ–±—ä–µ–∫—Ç–∞...', 'scanning');
                    stableFrameCount = 0;
                    hideStabilityIndicator();
                }
            }, 'image/jpeg', 0.85); // –ù–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∑–∏–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ AR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', error);
            updateRecognitionStatus('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è', 'error');
            stableFrameCount = 0;
            hideStabilityIndicator();
        }
    }

    // –î–µ—Ç–µ–∫—Ü–∏—è AR –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    async function detectAR() {
        if (!isScanning || detectedObjectId !== null) {
            return;
        }

        const now = Date.now();
        if (now - lastARCheckTime < arCheckInterval) {
            return;
        }

        if (video.readyState !== video.HAVE_ENOUGH_DATA) {
            return;
        }

        try {
            if (!updateCanvas()) {
                return;
            }

            const frameData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            if (isFrameStable(frameData)) {
                stableFrameCount++;
                showStabilityIndicator(stableFrameCount, stableFrameThreshold);
                console.log(`–°—Ç–∞–±–∏–ª—å–Ω—ã–π –∫–∞–¥—Ä ${stableFrameCount}/${stableFrameThreshold}`);

                if (stableFrameCount >= stableFrameThreshold) {
                    console.log('–ö–∞–¥—Ä —Å—Ç–∞–±–∏–ª–µ–Ω, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ ORB...');
                    lastARCheckTime = now;
                    stableFrameCount = 0;
                    await recognizeImageWithORB();
                }
            } else {
                if (stableFrameCount > 0) {
                    console.log('–ö–∞–¥—Ä –∏–∑–º–µ–Ω–∏–ª—Å—è, —Å–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞');
                    stableFrameCount = 0;
                    hideStabilityIndicator();
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ AR —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', e);
            stableFrameCount = 0;
            hideStabilityIndicator();
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–µ—Ç–µ–∫—Ç–æ—Ä—ã
    detectQR();

    // AR –¥–µ—Ç–µ–∫—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º
    setInterval(() => {
        if (isScanning) {
            detectAR();
        }
    }, 200); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 200–º—Å –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
}

// –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
function showStabilityIndicator(current, total) {
    const indicator = document.getElementById('stabilityIndicator');
    const progress = document.getElementById('stabilityProgress');
    const percentage = (current / total) * 100;

    indicator.classList.remove('hidden');
    progress.style.width = percentage + '%';
}

// –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
function hideStabilityIndicator() {
    const indicator = document.getElementById('stabilityIndicator');
    const progress = document.getElementById('stabilityProgress');

    indicator.classList.add('hidden');
    progress.style.width = '0%';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω–æ–≥–æ QR –∫–æ–¥–∞
async function handleQRCodeDetected(qrString) {
    console.log('üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ QR –∫–æ–¥–∞:', qrString);
    updateRecognitionStatus('QR –∫–æ–¥ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω, –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö...', 'success');

    try {
        const resp = await fetch(`/objects/api/search-qr?qr_string=${encodeURIComponent(qrString)}`);
        if (!resp.ok) {
            if (resp.status === 404) {
                updateRecognitionStatus('QR –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', 'info');
                setTimeout(() => {
                    detectedQRString = null;
                    updateRecognitionStatus('–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é...', 'scanning');
                }, 3000);
            } else {
                throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ (—Å—Ç–∞—Ç—É—Å: ${resp.status})`);
            }
            return;
        }

        const result = await resp.json();
        console.log('‚úÖ QR –æ–±—ä–µ–∫—Ç –Ω–∞–π–¥–µ–Ω:', result.data);
        isScanning = false;

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ–±—ä–µ–∫—Ç–∞
        if (result.data && result.data.id) {
            updateRecognitionStatus('–û–±—ä–µ–∫—Ç –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ—Ö–æ–¥...', 'success');
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
            stopCameraStream();
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            window.location.href = `/objects/view/${result.data.id}`;
        }
    } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ QR –æ–±—ä–µ–∫—Ç–∞:', err);
        updateRecognitionStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ: ' + err.message, 'error');
        setTimeout(() => {
            detectedQRString = null;
            updateRecognitionStatus('–ì–æ—Ç–æ–≤ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é...', 'scanning');
        }, 3000);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
function updateRecognitionStatus(text, type = 'scanning') {
    const statusDiv = document.getElementById('recognitionStatus');
    const statusText = document.getElementById('statusText');
    if (!statusDiv || !statusText) return;

    statusDiv.classList.remove('hidden');
    statusText.textContent = text;

    statusText.classList.remove('text-gray-500', 'text-green-600', 'text-blue-600', 'text-red-600');

    if (type === 'success') {
        statusText.classList.add('text-green-600', 'font-semibold');
    } else if (type === 'info') {
        statusText.classList.add('text-blue-600');
    } else if (type === 'error') {
        statusText.classList.add('text-red-600');
    } else {
        statusText.classList.add('text-gray-500');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    init();
});

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –≤—ã–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    stopCameraStream();
});
</script>

<style>
#scannerContainer {
    min-height: 500px;
}

#stabilityIndicator {
    animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}
