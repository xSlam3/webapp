{% extends "base.html" %}

{% block content %}
<div class="max-w-md mx-auto mt-4 sm:mt-10 p-4 sm:p-6 bg-white rounded-lg shadow-md">
    <h1 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6 text-center">üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h1>

    <!-- –û—à–∏–±–∫–∏ -->
    <div id="errorAlert" class="hidden mb-4 bg-red-50 border-l-4 border-red-500 p-4 rounded-lg">
        <div class="flex">
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">–û—à–∏–±–∫–∞</h3>
                <div class="mt-2 text-sm text-red-700">
                    <ul class="list-disc list-inside space-y-1" id="errorList"></ul>
                </div>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="closeError()" class="text-red-400 hover:text-red-600">‚úñ</button>
            </div>
        </div>
    </div>

    <!-- –£—Å–ø–µ—Ö -->
    <div id="successAlert" class="hidden mb-4 bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
        <div class="flex">
            <div class="ml-3">
                <h3 class="text-sm font-medium text-green-800">–£—Å–ø–µ—Ö</h3>
                <div class="mt-2 text-sm text-green-700" id="successMsg"></div>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="closeSuccess()" class="text-green-400 hover:text-green-600">‚úñ</button>
            </div>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <form id="loginForm" class="space-y-4">
        <div>
            <label for="loginUsername" class="block text-sm font-medium text-gray-700">–õ–æ–≥–∏–Ω</label>
            <input type="text" id="loginUsername" name="username" required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-base"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω">
        </div>
        <div>
            <label for="loginPassword" class="block text-sm font-medium text-gray-700">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="loginPassword" name="password" required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-base"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        </div>
        <button type="submit" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed text-base min-h-[44px]">
            –í–æ–π—Ç–∏
        </button>
    </form>
</div>

<script>
const loginForm = document.getElementById("loginForm");

const errorAlert = document.getElementById("errorAlert");
const errorList = document.getElementById("errorList");
const successAlert = document.getElementById("successAlert");
const successMsg = document.getElementById("successMsg");

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
const showError = (msg) => {
    errorList.innerHTML = "";
    if (Array.isArray(msg)) {
        msg.forEach(m => {
            const li = document.createElement("li");
            li.textContent = m;
            errorList.appendChild(li);
        });
    } else {
        const li = document.createElement("li");
        li.textContent = msg;
        errorList.appendChild(li);
    }
    errorAlert.classList.remove("hidden");
    setTimeout(closeError, 7000);
};

const closeError = () => errorAlert.classList.add("hidden");

const showSuccess = (msg) => {
    successMsg.textContent = msg;
    successAlert.classList.remove("hidden");
    setTimeout(closeSuccess, 5000);
};

const closeSuccess = () => successAlert.classList.add("hidden");

// –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
function setFormLoading(form, loading) {
    const btn = form.querySelector('button[type="submit"]');
    btn.disabled = loading;
    if (loading) {
        btn.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    } else {
        btn.textContent = "–í–æ–π—Ç–∏";
    }
}

// –í—Ö–æ–¥
loginForm.addEventListener("submit", async e => {
    e.preventDefault();
    closeError();
    closeSuccess();
    setFormLoading(loginForm, true);

    const formData = new FormData(loginForm);

    try {
        const resp = await fetch("/auth/login", {
            method: "POST",
            body: formData
        });

        const data = await resp.json();

        if (resp.ok) {
            showSuccess(data.message || "–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!");

            // –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
            setTimeout(() => {
                if (data.is_admin) {
                    window.location.href = "/auth/admin";
                } else {
                    window.location.href = "/knowledge_base/";
                }
            }, 1000);
        } else {
            showError(data.detail || "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞");
        }
    } catch (err) {
        showError("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
    } finally {
        setFormLoading(loginForm, false);
    }
});

// –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ
document.getElementById("loginUsername").focus();
</script>
{% endblock %}